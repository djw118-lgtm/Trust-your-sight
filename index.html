<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Your Sight - Retinal Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        .scanner-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .camera-view {
            flex: 1;
            position: relative;
            background: #000;
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .eye-target {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120px;
            height: 120px;
            border: 3px solid #22c55e;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .eye-target.positioned {
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .eye-target.capturing {
            border-color: #ef4444;
            animation: pulse 0.5s ease-in-out;
            background: rgba(239, 68, 68, 0.2);
        }

        .eye-target.captured {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .direction-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            color: #22c55e;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .instruction-text {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            margin: 0 10px;
            flex: 1;
        }

        .progress-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }

        .scan-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .scan-complete.show {
            display: block;
        }

        .scan-complete h2 {
            color: #22c55e;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .scan-complete p {
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .results-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .results-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .position-grid {
            position: absolute;
            top: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(3, 20px);
            grid-template-rows: repeat(3, 20px);
            gap: 4px;
        }

        .position-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .position-dot.completed {
            background: #22c55e;
        }

        .position-dot.current {
            background: #ef4444;
            animation: pulse 0.5s infinite;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="camera-view">
            <video id="scannerVideo" autoplay muted playsinline></video>
            
            <div class="overlay">
                <div class="eye-target" id="eyeTarget"></div>
                <div class="direction-arrow" id="directionArrow">üëÅÔ∏è</div>
            </div>
            
            <div class="progress-indicator" id="progressText">
                Right Eye - Position 1 of 9
            </div>

            <div class="position-grid" id="positionGrid">
                <!-- 9 position dots -->
                <div class="position-dot" data-position="0"></div>
                <div class="position-dot" data-position="1"></div>
                <div class="position-dot" data-position="2"></div>
                <div class="position-dot" data-position="3"></div>
                <div class="position-dot" data-position="4"></div>
                <div class="position-dot" data-position="5"></div>
                <div class="position-dot" data-position="6"></div>
                <div class="position-dot" data-position="7"></div>
                <div class="position-dot" data-position="8"></div>
            </div>
        </div>

        <div class="control-panel">
            <button class="control-btn" id="muteBtn" onclick="toggleAudio()">üîä</button>
            <div class="instruction-text" id="instructionText">
                Position phone 6-8 inches from your right eye. Cover left eye with hand.
            </div>
            <button class="control-btn" id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è</button>
            <button class="control-btn" id="exitBtn" onclick="exitScanner()">‚ùå</button>
        </div>

        <div class="scan-complete" id="scanComplete">
            <h2>‚úÖ Scan Complete!</h2>
            <p>Your retinal health scan has been completed successfully. Analysis will be available shortly.</p>
            <button class="results-btn" onclick="viewResults()">View Results</button>
        </div>
    </div>

    <script>
        let currentEye = 'right';
        let currentPosition = 0;
        let totalPositions = 9;
        let isScanning = false;
        let isPaused = false;
        let audioEnabled = true;
        let scanTimer;
        
        // Complete 9-position sequence for each eye
        const scanPositions = [
            { name: 'center', instruction: 'Look straight ahead at the camera', arrow: 'üëÅÔ∏è' },
            { name: 'up', instruction: 'Look up', arrow: '‚¨ÜÔ∏è' },
            { name: 'up-right', instruction: 'Look up and to your right', arrow: '‚ÜóÔ∏è' },
            { name: 'right', instruction: 'Look to your right', arrow: '‚û°Ô∏è' },
            { name: 'down-right', instruction: 'Look down and to your right', arrow: '‚ÜòÔ∏è' },
            { name: 'down', instruction: 'Look down', arrow: '‚¨áÔ∏è' },
            { name: 'down-left', instruction: 'Look down and to your left', arrow: '‚ÜôÔ∏è' },
            { name: 'left', instruction: 'Look to your left', arrow: '‚¨ÖÔ∏è' },
            { name: 'up-left', instruction: 'Look up and to your left', arrow: '‚ÜñÔ∏è' }
        ];

        function speak(text, rate = 1) {
            if (!audioEnabled) return;
            
            try {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = rate;
                    utterance.pitch = 1;
                    utterance.volume = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    showTextInstruction(text);
                }
            } catch (error) {
                showTextInstruction(text);
            }
        }

        function showTextInstruction(text) {
            const instructionEl = document.getElementById('instructionText');
            const originalBg = instructionEl.style.backgroundColor;
            instructionEl.style.backgroundColor = '#fbbf24';
            instructionEl.style.color = '#000';
            instructionEl.textContent = text;
            
            setTimeout(() => {
                instructionEl.style.backgroundColor = originalBg;
                instructionEl.style.color = '#fff';
            }, 2000);
        }

        function vibrate() {
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
            }
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user', // Front-facing camera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                const video = document.getElementById('scannerVideo');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    setTimeout(() => {
                        if (!isScanning) {
                            startScanning();
                        }
                    }, 1000);
                };
                
            } catch (error) {
                console.error('Camera access error:', error);
                showTextInstruction('Camera access required. Please allow camera permission and reload.');
            }
        }

        function startScanning() {
            if (isScanning || isPaused) return;
            
            isScanning = true;
            currentEye = 'right';
            currentPosition = 0;
            
            speak("Starting retinal scan. Cover your left eye with your hand and look straight ahead.", 0.9);
            
            setTimeout(() => {
                performPositionScan();
            }, 3000);
        }

        function performPositionScan() {
            if (isPaused || !isScanning) return;
            
            const position = scanPositions[currentPosition];
            const eyeText = currentEye === 'right' ? 'Right' : 'Left';
            const coverEye = currentEye === 'right' ? 'left' : 'right';
            
            // Update UI
            document.getElementById('progressText').textContent = 
                `${eyeText} Eye - Position ${currentPosition + 1} of ${totalPositions}`;
            
            document.getElementById('directionArrow').textContent = position.arrow;
            
            const instructionText = currentPosition === 0 ? 
                `Cover your ${coverEye} eye with your hand. ${position.instruction}` :
                position.instruction;
            
            document.getElementById('instructionText').textContent = instructionText;
            
            // Update position grid
            updatePositionGrid();
            
            // Audio instruction
            speak(instructionText, 0.8);
            
            // Positioning phase (4 seconds)
            const target = document.getElementById('eyeTarget');
            target.className = 'eye-target positioned';
            
            setTimeout(() => {
                if (!isPaused && isScanning) {
                    capturePosition();
                }
            }, 4000);
        }

        function capturePosition() {
            if (isPaused || !isScanning) return;
            
            const target = document.getElementById('eyeTarget');
            target.className = 'eye-target capturing';
            
            speak('Hold steady', 1.2);
            vibrate();
            
            // Capture simulation (1 second)
            setTimeout(() => {
                if (!isPaused && isScanning) {
                    target.className = 'eye-target captured';
                    speak('Captured', 1.2);
                    
                    // Update position grid
                    markPositionCompleted(currentPosition);
                    
                    setTimeout(() => {
                        if (!isPaused && isScanning) {
                            nextPosition();
                        }
                    }, 1500);
                }
            }, 1000);
        }

        function nextPosition() {
            if (isPaused || !isScanning) return;
            
            currentPosition++;
            
            if (currentPosition >= totalPositions) {
                if (currentEye === 'right') {
                    // Switch to left eye
                    currentEye = 'left';
                    currentPosition = 0;
                    
                    speak("Right eye complete. Now cover your right eye with your hand for left eye scanning.", 0.8);
                    
                    setTimeout(() => {
                        if (!isPaused && isScanning) {
                            performPositionScan();
                        }
                    }, 3000);
                } else {
                    // Both eyes complete
                    completeScan();
                }
            } else {
                performPositionScan();
            }
        }

        function completeScan() {
            isScanning = false;
            
            speak("Scan complete. Analyzing results.", 0.8);
            
            setTimeout(() => {
                document.getElementById('scanComplete').classList.add('show');
                speak("Your retinal health scan is complete. Results are ready for review.", 0.8);
            }, 2000);
        }

        function updatePositionGrid() {
            const dots = document.querySelectorAll('.position-dot');
            const baseIndex = currentEye === 'right' ? 0 : 9;
            
            dots.forEach((dot, index) => {
                const relativeIndex = index % 9;
                const isCurrentEye = currentEye === 'right' ? index < 9 : index >= 9;
                
                if (isCurrentEye && relativeIndex === currentPosition) {
                    dot.className = 'position-dot current';
                } else if (isCurrentEye && relativeIndex < currentPosition) {
                    dot.className = 'position-dot completed';
                } else {
                    dot.className = 'position-dot';
                }
            });
        }

        function markPositionCompleted(position) {
            const dots = document.querySelectorAll('.position-dot');
            const baseIndex = currentEye === 'right' ? 0 : 9;
            const dotIndex = baseIndex + position;
            
            if (dots[dotIndex]) {
                dots[dotIndex].className = 'position-dot completed';
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('muteBtn');
            btn.textContent = audioEnabled ? 'üîä' : 'üîá';
            
            try {
                speak(audioEnabled ? "Audio enabled" : "Audio disabled");
            } catch (error) {
                showTextInstruction(audioEnabled ? "Audio enabled" : "Audio disabled");
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            
            if (isPaused) {
                speak("Scan paused");
            } else {
                speak("Scan resumed");
                if (isScanning) {
                    setTimeout(() => {
                        performPositionScan();
                    }, 1000);
                }
            }
        }

        function exitScanner() {
            if (confirm('Exit scanner? Your progress will be lost.')) {
                isScanning = false;
                isPaused = false;
                speak("Scanner exited");
                // In a real app, this would navigate back or close the scanner
                window.history.back();
            }
        }

        function viewResults() {
            // In a real app, this would navigate to results page
            speak("Loading results page");
            alert("Results page would load here");
        }

        // Initialize the scanner when page loads
        document.addEventListener('DOMContentLoaded', function() {
            speak("Welcome to the Trust Your Sight retinal scanner. Please hold your phone 6 to 8 inches from your face.", 0.8);
            
            setTimeout(() => {
                initCamera();
            }, 2000);
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                isPaused = true;
                isScanning = false;
            }
        });

        console.log('Trust Your Sight - Complete 9-Position Retinal Scanner Loaded');
    </script>
</body>
</html>
