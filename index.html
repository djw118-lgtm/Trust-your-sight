<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trust Your Sight - AI Eye Health Scanner</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; line-height: 1.6; overflow-x: hidden; }
.container { max-width: 400px; margin: 0 auto; min-height: 100vh; position: relative; }
.section { padding: 20px; display: none; }
.section.active { display: block; }
.header { text-align: center; margin-bottom: 30px; padding: 20px 0; }
.logo { font-size: 48px; margin-bottom: 10px; }
.app-title { font-size: 28px; font-weight: 700; background: linear-gradient(45deg, #22c55e, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
.subtitle { font-size: 16px; color: #94a3b8; font-weight: 400; }
.feature-grid { display: grid; gap: 15px; margin: 25px 0; }
.feature-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; }
.feature-card:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
.feature-icon { font-size: 32px; margin-bottom: 10px; }
.feature-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #e2e8f0; }
.feature-desc { font-size: 14px; color: #94a3b8; }
.scanner-container { width: 100vw; height: 100vh; position: relative; display: flex; flex-direction: column; background: #000; }
.camera-view { flex: 1; position: relative; background: #000; }
#scannerVideo { width: 100%; height: 100%; object-fit: cover; }
.overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; }
.camera-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px; }
.control-btn { width: 50px; height: 50px; border: 2px solid white; border-radius: 50%; background: rgba(0, 0, 0, 0.7); color: white; font-size: 20px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
.control-btn:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
.control-btn.pause { background: rgba(255, 193, 7, 0.8); }
.control-btn.close { background: rgba(220, 53, 69, 0.8); }
.control-btn.camera-flip { background: rgba(13, 110, 253, 0.8); }
.control-btn.sound-toggle { background: rgba(34, 197, 94, 0.8); }
.eye-target { position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; border: 3px solid #22c55e; border-radius: 50%; transform: translate(-50%, -50%); transition: all 0.3s ease; }
.eye-target.positioned { border-color: #22c55e; box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
.eye-target.capturing { border-color: #ef4444; animation: pulse 0.5s ease-in-out; background: rgba(239, 68, 68, 0.2); }
.eye-target.captured { border-color: #22c55e; background: rgba(34, 197, 94, 0.2); }
@keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }
.controls { padding: 20px; background: rgba(0, 0, 0, 0.8); text-align: center; }
.btn { padding: 15px 30px; margin: 10px; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
.btn-primary { background: linear-gradient(45deg, #22c55e, #16a34a); color: white; }
.btn-primary:hover { background: linear-gradient(45deg, #16a34a, #15803d); transform: translateY(-2px); box-shadow: 0 10px 25px rgba(34, 197, 94, 0.3); }
.btn-secondary { background: rgba(148, 163, 184, 0.2); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.3); }
.btn-secondary:hover { background: rgba(148, 163, 184, 0.3); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.instruction-text { font-size: 20px; text-align: center; margin-bottom: 20px; color: white; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7); }
.progress-bar { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 3px; overflow: hidden; margin: 20px 0; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #3b82f6); border-radius: 3px; transition: width 0.3s ease; }
.results-section { padding: 30px 20px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
.results-header { text-align: center; margin-bottom: 30px; }
.results-header h3 { font-size: 28px; color: #22c55e; margin-bottom: 10px; }
.results-grid { display: grid; gap: 20px; margin-bottom: 30px; }
.result-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; }
.result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.result-title { font-size: 18px; font-weight: 600; color: #e2e8f0; }
.confidence-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
.confidence-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
.confidence-medium { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }
.confidence-low { background: rgba(34, 197, 94, 0.2); color: #86efac; }
.result-description { color: #94a3b8; font-size: 14px; line-height: 1.5; }
.disclaimer { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; }
.disclaimer-title { font-weight: 600; color: #fca5a5; margin-bottom: 8px; }
.disclaimer-text { color: #94a3b8; font-size: 14px; }
.next-steps { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 20px; margin: 20px 0; }
.next-steps h4 { color: #86efac; margin-bottom: 15px; }
.next-steps ul { color: #94a3b8; padding-left: 20px; }
.next-steps li { margin-bottom: 8px; }
.checkbox-item { display: flex; align-items: flex-start; margin: 16px 0; padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; }
.checkbox-item input { margin-right: 12px; margin-top: 2px; transform: scale(1.2); }
.checkbox-item label { font-size: 14px; line-height: 1.4; }
@media (max-width: 480px) {
.container { max-width: 100%; padding: 0 10px; }
.app-title { font-size: 24px; }
.feature-grid { gap: 10px; }
}
@media (min-width: 768px) {
.container { max-width: 800px; }
.feature-grid { grid-template-columns: repeat(2, 1fr); }
.results-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>
<div class="container">
<!-- Age Verification Section -->
<div id="ageVerificationSection" class="section active">
<div class="header">
<div class="logo">üëÅÔ∏è</div>
<h1 class="app-title">Trust Your Sight</h1>
<p class="subtitle">AI-Powered Eye Health Screening</p>
</div>
<div style="text-align: center; margin: 40px 0;">
<h3 style="color: #e2e8f0; margin-bottom: 30px;">Age Verification Required</h3>
<p style="color: #94a3b8; margin-bottom: 40px;">This medical screening tool requires age verification for appropriate use.</p>
<button class="btn btn-primary" onclick="selectAge('over18')" style="display: block; margin: 15px auto; width: 250px;">
I am 18 years or older
</button>
<button class="btn btn-secondary" onclick="selectAge('under18')" style="display: block; margin: 15px auto; width: 250px;">
I am under 18 years old
</button>
</div>
</div>

<!-- Plan Selection Section -->
<div id="planSelectionSection" class="section">
<div class="header">
<div class="logo">üëÅÔ∏è</div>
<h1 class="app-title">Trust Your Sight</h1>
<p class="subtitle">Choose Your Scanning Plan</p>
</div>
<div style="display: grid; gap: 20px; margin: 30px 0;">
<div class="feature-card" onclick="selectPlan('single')" style="cursor: pointer; border: 2px solid transparent;">
<div class="feature-icon">üë§</div>
<h3 class="feature-title">Single Plan</h3>
<p class="feature-desc">Perfect for individual health monitoring</p>
<div style="color: #22c55e; font-weight: 600; font-size: 18px; margin-top: 10px;">$19.99/month</div>
</div>
<div class="feature-card" onclick="selectPlan('family')" style="cursor: pointer; border: 2px solid transparent;">
<div class="feature-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
<h3 class="feature-title">Family Plan</h3>
<p class="feature-desc">Scan up to 5 family members including children</p>
<div style="color: #22c55e; font-weight: 600; font-size: 18px; margin-top: 10px;">$29.99/month</div>
</div>
<div class="feature-card" onclick="selectPlan('senior')" style="cursor: pointer; border: 2px solid transparent;">
<div class="feature-icon">üë¥</div>
<h3 class="feature-title">Senior Plan</h3>
<p class="feature-desc">Enhanced monitoring for ages 65+ with priority support</p>
<div style="color: #22c55e; font-weight: 600; font-size: 18px; margin-top: 10px;">$12.99/month</div>
</div>
</div>
</div>

<!-- Consent Section -->
<div id="consentSection" class="section">
<div class="header">
<h2>Medical Disclaimers & Consent</h2>
<p class="subtitle">Please read and acknowledge the following</p>
</div>

<div class="disclaimer">
<div class="disclaimer-title">Important Medical Disclaimer</div>
<div class="disclaimer-text">This app is for screening purposes only and does not replace professional medical diagnosis. Always consult with qualified healthcare providers for medical decisions.</div>
</div>

<div style="margin: 20px 0;">
<div class="checkbox-item">
<input type="checkbox" id="consent1" onchange="checkConsents()">
<label for="consent1">I understand this is a screening tool only and not a medical diagnosis. I will consult healthcare professionals for any concerning results.</label>
</div>

<div class="checkbox-item">
<input type="checkbox" id="consent2" onchange="checkConsents()">
<label for="consent2">I consent to the capture and analysis of my retinal images for health screening purposes.</label>
</div>

<div class="checkbox-item">
<input type="checkbox" id="consent3" onchange="checkConsents()">
<label for="consent3">I confirm I am 18 years or older and understand the limitations of this screening technology.</label>
</div>
</div>

<button class="btn btn-primary" id="proceedBtn" onclick="proceedToWelcome()" disabled style="width: 100%;">Continue to Scanning</button>
</div>

<!-- Welcome Section -->
<div id="welcomeSection" class="section">
<div class="header">
<div class="logo">üëÅÔ∏è</div>
<h1 class="app-title">Trust Your Sight</h1>
<p class="subtitle">Welcome to Your Retinal Scanner</p>
</div>
<div style="text-align: center; margin: 30px 0;">
<h3 style="color: #e2e8f0; margin-bottom: 20px;">Ready to Begin Your Eye Health Scan</h3>
<p style="color: #94a3b8; margin-bottom: 30px;">Your personalized retinal analysis will take approximately 2 minutes to complete both eyes.</p>
</div>

<!-- Important Health Notice -->
<div style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center; border: 2px solid #ef4444;">
<h4 style="color: white; margin-bottom: 10px;">‚ö†Ô∏è Important Health Notice</h4>
<div style="color: #fecaca; font-size: 14px; line-height: 1.6;">
This screening tool provides preliminary health indicators only. Results must be confirmed by qualified medical professionals. Never delay professional medical care based on these results.
</div>
</div>

<div style="text-align: center;">
<button class="btn btn-primary" onclick="startScan()">Start Eye Scan</button>
<button class="btn btn-secondary" onclick="showDemoResults()">View Demo Results</button>
<button class="btn btn-secondary" onclick="showTestimonials()">User Stories</button>
</div>

<div class="header">
<div class="logo">üëÅÔ∏è</div>
<h1 class="app-title">Trust Your Sight</h1>
<p class="subtitle">AI-Powered Eye Health Screening</p>
</div>
<div class="feature-grid">
<div class="feature-card">
<div class="feature-icon">üî¨</div>
<h3 class="feature-title">Advanced AI Analysis</h3>
<p class="feature-desc">Detect early signs of diabetic retinopathy and other eye conditions</p>
</div>
<div class="feature-card">
<div class="feature-icon">üì±</div>
<h3 class="feature-title">Smartphone Powered</h3>
<p class="feature-desc">Professional-grade scanning using your phone's camera</p>
</div>
<div class="feature-card">
<div class="feature-icon">‚ö°</div>
<h3 class="feature-title">Instant Results</h3>
<p class="feature-desc">Get comprehensive health insights in under 2 minutes</p>
</div>
<div class="feature-card">
<div class="feature-icon">üè•</div>
<h3 class="feature-title">Medical Integration</h3>
<p class="feature-desc">Share results directly with your healthcare provider</p>
</div>
</div>

<div style="background: #1e293b; border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center;">
<h4 style="color: #22c55e; margin-bottom: 10px;">üì± Enhanced Features</h4>
<div style="color: #cbd5e1; font-size: 14px; line-height: 1.6;">
‚úÖ <strong>9-Position Comprehensive Scan</strong> - Complete retinal coverage<br>
‚úÖ <strong>Dual Camera Support</strong> - Front camera (self) + Back camera (family)<br>
‚úÖ <strong>Smart Controls</strong> - Pause, exit, camera switching<br>
‚úÖ <strong>Vibration + Sound Feedback</strong> - Audio/haptic confirmation<br>
‚úÖ <strong>Family Mode</strong> - Perfect for scanning children with back camera
</div>
</div>

<div style="background: #1e293b; border-radius: 15px; padding: 20px; margin: 20px 0;">
<h4 style="color: #3b82f6; margin-bottom: 15px; text-align: center;">üîç What We Can Detect</h4>
<div style="display: grid; gap: 12px;">
<div style="background: rgba(34, 197, 94, 0.1); border-radius: 8px; padding: 12px; border-left: 4px solid #22c55e;">
<div style="color: #86efac; font-weight: 600; font-size: 14px;">üíô Cardiovascular Health</div>
<div style="color: #cbd5e1; font-size: 13px;">Blood vessel changes that may indicate heart health concerns</div>
</div>
<div style="background: rgba(251, 191, 36, 0.1); border-radius: 8px; padding: 12px; border-left: 4px solid #fbbf24;">
<div style="color: #fcd34d; font-weight: 600; font-size: 14px;">ü©∫ Diabetes Screening</div>
<div style="color: #cbd5e1; font-size: 13px;">Early detection of diabetic retinopathy risk indicators</div>
</div>
<div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 12px; border-left: 4px solid #ef4444;">
<div style="color: #fca5a5; font-weight: 600; font-size: 14px;">ü©∏ Blood Pressure Signs</div>
<div style="color: #cbd5e1; font-size: 13px;">Retinal patterns associated with hypertension</div>
</div>
<div style="background: rgba(168, 85, 247, 0.1); border-radius: 8px; padding: 12px; border-left: 4px solid #a855f7;">
<div style="color: #c4b5fd; font-weight: 600; font-size: 14px;">üß† Neurological Health</div>
<div style="color: #cbd5e1; font-size: 13px;">Optic nerve health and potential neurological indicators</div>
</div>
</div>
<div style="text-align: center; margin-top: 15px;">
<a href="https://www.nature.com/articles/nature19676" target="_blank" style="color: #3b82f6; font-size: 12px; text-decoration: underline;">
üìö Based on Google's Official Diabetic Retinopathy Research (Nature 2016)
</a>
<br>
<a href="https://jamanetwork.com/journals/jama/fullarticle/2588763" target="_blank" style="color: #3b82f6; font-size: 11px; text-decoration: underline; margin-top: 5px; display: inline-block;">
üî¨ View Full Research Paper
</a>
</div>
<div style="text-align: center; margin-top: 15px; color: #94a3b8; font-size: 12px; font-style: italic;">
*All results require professional medical confirmation
</div>
</div>
<div class="disclaimer">
<div class="disclaimer-title">Medical Disclaimer</div>
<div class="disclaimer-text">This app is for screening purposes only and does not replace professional medical diagnosis. Always consult with qualified healthcare providers for medical decisions.</div>
</div>
<div style="text-align: center;">
<button class="btn btn-primary" onclick="startScan()">Start Eye Scan</button>
<button class="btn btn-secondary" onclick="showDemoResults()">View Demo Results</button>
<button class="btn btn-secondary" onclick="showTestimonials()">User Stories</button>
</div>
</div>

<!-- Scanning Section -->
<div id="scanningSection" class="section">
<div class="camera-view">
<video id="scannerVideo" autoplay muted playsinline></video>
<div class="camera-controls">
<button class="control-btn camera-flip" onclick="flipCamera()" title="Switch Camera">üì∑</button>
<button class="control-btn sound-toggle" onclick="toggleSound()" title="Toggle Sound">üîä</button>
<button class="control-btn pause" onclick="pauseScan()" title="Pause">‚è∏Ô∏è</button>
<button class="control-btn close" onclick="exitScan()" title="Exit">‚úñÔ∏è</button>
</div>
<div class="overlay">
<div class="eye-target" id="eyeTarget"></div>
</div>
</div>
<div class="controls">
<div class="instruction-text" id="instructionText">Position your face in the camera and get ready to scan</div>
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>
</div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="section">
<div class="results-section">
<div class="results-header">
<h3>Scan Complete!</h3>
<p>AI analysis results are ready</p>
</div>
<div class="disclaimer">
<div class="disclaimer-title">Important Medical Disclaimer</div>
<div class="disclaimer-text">This screening tool is not a medical diagnosis. These results are preliminary indicators only and require confirmation by a qualified eye care professional. Do not delay seeking professional medical care based on these results.</div>
</div>
<div class="results-grid" id="resultsGrid"></div>
<div class="next-steps">
<h4>Recommended Next Steps:</h4>
<ul>
<li>Schedule an appointment with an ophthalmologist or optometrist</li>
<li>Share these results with your healthcare provider</li>
<li>Continue regular professional eye exams as recommended by your doctor</li>
<li>Monitor any changes in your vision and report them promptly</li>
</ul>
</div>
<div style="text-align: center; margin-top: 30px;">
<button class="btn btn-primary" onclick="shareResults()">Share Results</button>
<button class="btn btn-secondary" onclick="startNewScan()">New Scan</button>
<button class="btn btn-secondary" onclick="goHome()">Return Home</button>
</div>
</div>
</div>
</div>

<script>
// Navigation functions
function selectAge(ageGroup) {
if (ageGroup === 'under18') {
alert('‚ö†Ô∏è Age Restriction\n\nThis medical screening tool is designed for adults 18 years and older. Please consult with a parent or guardian and your healthcare provider for appropriate eye health screening options.');
return;
}
document.getElementById('ageVerificationSection').style.display = 'none';
document.getElementById('planSelectionSection').style.display = 'block';
}

function selectPlan(plan) {
let planName = '';
switch(plan) {
case 'single': planName = 'Single Plan ($19.99/month)'; break;
case 'family': planName = 'Family Plan ($29.99/month)'; break;
case 'senior': planName = 'Senior Plan ($12.99/month)'; break;
}
showMessage(`${planName} selected!`, 1500);
setTimeout(() => {
document.getElementById('planSelectionSection').style.display = 'none';
document.getElementById('consentSection').style.display = 'block';
}, 1500);
}

function checkConsents() {
const consent1 = document.getElementById('consent1').checked;
const consent2 = document.getElementById('consent2').checked;
const consent3 = document.getElementById('consent3').checked;
document.getElementById('proceedBtn').disabled = !(consent1 && consent2 && consent3);
}

function proceedToWelcome() {
document.getElementById('consentSection').style.display = 'none';
document.getElementById('welcomeSection').style.display = 'block';
}

// Global variables
let currentPosition = 0;
let currentEye = 'right';
let isScanning = false;
let isPaused = false;
let stream = null;
let currentCamera = 'user';
let soundEnabled = true;
let scanningTimeout = null;

// Scan positions
const scanPositions = [
{ text: "Look straight ahead", emoji: "üëÅÔ∏è" },
{ text: "Look up", emoji: "‚¨ÜÔ∏è" },
{ text: "Look to your right", emoji: "‚û°Ô∏è" },
{ text: "Look down", emoji: "‚¨áÔ∏è" },
{ text: "Look to your left", emoji: "‚¨ÖÔ∏è" },
{ text: "Look up and to your right", emoji: "‚ÜóÔ∏è" },
{ text: "Look up and to your left", emoji: "‚ÜñÔ∏è" },
{ text: "Look down and to your left", emoji: "‚ÜôÔ∏è" },
{ text: "Look down and to your right", emoji: "‚ÜòÔ∏è" }
];

// Demo results data
const demoResults = [
{ title: "Diabetic Retinopathy Risk Indicators", confidence: "medium", description: "Some patterns warrant professional evaluation for potential diabetic eye complications." },
{ title: "Hypertension Signs", confidence: "medium", description: "Blood vessel patterns suggest elevated blood pressure may be affecting retinal health." },
{ title: "Cardiovascular Health Markers", confidence: "high", description: "Patterns detected that require prompt medical attention for cardiovascular assessment." },
{ title: "Retinal Blood Vessel Condition", confidence: "medium", description: "Some irregularities in blood vessel patterns noted, professional evaluation recommended." },
{ title: "Optic Nerve Health", confidence: "low", description: "No concerning patterns detected in this scan. Continue regular monitoring." },
{ title: "Cholesterol Indicators", confidence: "medium", description: "Patterns that may indicate cholesterol-related changes in retinal blood vessels." }
];

// Camera functions
async function initCamera() {
try {
if (stream) {
stream.getTracks().forEach(track => track.stop());
}

if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
throw new Error('Camera not supported on this device');
}

const constraints = {
video: {
facingMode: currentCamera,
width: { ideal: 1920 },
height: { ideal: 1080 }
},
audio: false
};

stream = await navigator.mediaDevices.getUserMedia(constraints);
document.getElementById('scannerVideo').srcObject = stream;
updateCameraStatus();

} catch (error) {
console.error('Camera access failed:', error);
handleCameraError(error);
}
}

function handleCameraError(error) {
let message = '';
let instructions = '';

if (error.name === 'NotAllowedError' || error.message.includes('Permission denied')) {
message = 'üì∑ Camera Permission Required';
instructions = `To use Trust Your Sight, please:\n\nüîß Desktop/Laptop:\n‚Ä¢ Click the camera icon in your address bar\n‚Ä¢ Select "Allow" for camera access\n‚Ä¢ Refresh the page and try again\n\nüì± Mobile:\n‚Ä¢ Go to your browser settings\n‚Ä¢ Find "Site Permissions" or "Camera"\n‚Ä¢ Allow camera access for this site\n‚Ä¢ Return and try scanning again\n\nüí° Why we need camera access:\nYour camera captures retinal images for AI analysis. No images are stored or shared.`;
} else if (error.name === 'NotFoundError') {
message = 'üì∑ No Camera Found';
instructions = `Please check:\n‚Ä¢ Make sure your device has a camera\n‚Ä¢ Close other apps using the camera\n‚Ä¢ Try refreshing the page`;
} else if (error.name === 'NotReadableError') {
message = 'üì∑ Camera Busy';
instructions = `Camera might be in use by another app:\n‚Ä¢ Close other video apps (Zoom, Skype, etc.)\n‚Ä¢ Restart your browser\n‚Ä¢ Try again`;
} else {
message = 'üì∑ Camera Error';
instructions = `Something went wrong:\n‚Ä¢ Try refreshing the page\n‚Ä¢ Check your internet connection\n‚Ä¢ Contact support if problem persists`;
}

showCameraErrorDialog(message, instructions);
}

function showCameraErrorDialog(title, instructions) {
const errorDialog = document.createElement('div');
errorDialog.style.cssText = `position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px;`;

errorDialog.innerHTML = `
<div style="background: #1e293b; border-radius: 15px; padding: 30px; max-width: 400px; width: 100%; text-align: center; border: 2px solid #ef4444;">
<h3 style="color: #ef4444; margin-bottom: 20px; font-size: 20px;">${title}</h3>
<div style="color: #cbd5e1; font-size: 14px; line-height: 1.6; white-space: pre-line; text-align: left; margin-bottom: 25px;">${instructions}</div>
<div style="display: flex; gap: 10px; justify-content: center;">
<button onclick="retryCamera()" style="background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer;">Try Again</button>
<button onclick="closeErrorDialog()" style="background: rgba(148, 163, 184, 0.2); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.3); padding: 12px 24px; border-radius: 25px; font-weight: 600; cursor: pointer;">Go Back</button>
</div>
</div>
`;

document.body.appendChild(errorDialog);
window.currentErrorDialog = errorDialog;
}

function retryCamera() {
closeErrorDialog();
initCamera();
}

function closeErrorDialog() {
if (window.currentErrorDialog) {
document.body.removeChild(window.currentErrorDialog);
window.currentErrorDialog = null;
}
exitScan();
}

function updateCameraStatus() {
const cameraBtn = document.querySelector('.camera-flip');
if (currentCamera === 'user') {
cameraBtn.innerHTML = 'ü§≥';
cameraBtn.title = 'Switch to Back Camera (for family scanning)';
} else {
cameraBtn.innerHTML = 'üì∑';
cameraBtn.title = 'Switch to Front Camera (for self-scanning)';
}
}

async function flipCamera() {
currentCamera = currentCamera === 'user' ? 'environment' : 'user';
await initCamera();
const message = currentCamera === 'user' ? 'Front camera: Perfect for self-scanning' : 'Back camera: Great for scanning family members';
showMessage(message, 2000);
}

// Sound and speech functions
function toggleSound() {
soundEnabled = !soundEnabled;
const soundBtn = document.querySelector('.sound-toggle');
if (soundEnabled) {
soundBtn.innerHTML = 'üîä';
soundBtn.title = 'Sound On - Click to mute';
showMessage('Sound enabled', 1000);
} else {
soundBtn.innerHTML = 'üîá';
soundBtn.title = 'Sound Off - Click to enable';
showMessage('Sound muted', 1000);
}
}

function speak(text) {
if (!soundEnabled) return;
try {
if (typeof speechSynthesis !== 'undefined' && speechSynthesis) {
speechSynthesis.cancel();
const utterance = new SpeechSynthesisUtterance(text);
utterance.rate = 0.9;
utterance.pitch = 1;
utterance.volume = 0.8;
speechSynthesis.speak(utterance);
} else {
showMessage(text, 3000);
console.log('Speech instruction:', text);
}
} catch (error) {
showMessage(text, 3000);
console.log('Speech fallback:', text);
}
}

function playBeep() {
if (!soundEnabled) return;
try {
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
oscillator.frequency.value = 800;
oscillator.type = 'sine';
gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
oscillator.start(audioContext.currentTime);
oscillator.stop(audioContext.currentTime + 0.2);
} catch (error) {
console.log('Audio not supported:', error);
}
}

// Control functions
function pauseScan() {
isPaused = !isPaused;
const pauseBtn = document.querySelector('.pause');
if (isPaused) {
pauseBtn.innerHTML = '‚ñ∂Ô∏è';
pauseBtn.title = 'Resume';
showMessage('Scan paused', 1000);
} else {
pauseBtn.innerHTML = '‚è∏Ô∏è';
pauseBtn.title = 'Pause';
showMessage('Scan resumed', 1000);
if (isScanning) {
continueScanning();
}
}
}

function exitScan() {
if (confirm('Are you sure you want to exit the scan?')) {
isScanning = false; // CRITICAL FIX: Stop scanning immediately
emergencyStopScanning();
document.getElementById('welcomeSection').style.display = 'block';
document.getElementById('scanningSection').style.display = 'none';
}
}

function emergencyStopScanning() {
isScanning = false;
isPaused = false;
currentPosition = 0;
currentEye = 'right';

if (scanningTimeout) {
clearTimeout(scanningTimeout);
scanningTimeout = null;
}

// Clear any speech
if (typeof speechSynthesis !== 'undefined') {
speechSynthesis.cancel();
}

if (stream) {
stream.getTracks().forEach(track => track.stop());
stream = null;
}

const video = document.getElementById('scannerVideo');
if (video) {
video.srcObject = null;
}

document.getElementById('progressFill').style.width = '0%';

const eyeTarget = document.getElementById('eyeTarget');
if (eyeTarget) {
eyeTarget.className = 'eye-target';
}

console.log('Emergency stop: All scanning processes terminated');
}

function showMessage(text, duration = 3000) {
const messageDiv = document.createElement('div');
messageDiv.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 15px 25px; border-radius: 25px; z-index: 2000; font-size: 16px; font-weight: 600;`;
messageDiv.textContent = text;
document.body.appendChild(messageDiv);
setTimeout(() => {
if (document.body.contains(messageDiv)) {
document.body.removeChild(messageDiv);
}
}, duration);
}

// Scanning functions with FIXED audio timing
async function startScan() {
document.getElementById('welcomeSection').style.display = 'none';
document.getElementById('scanningSection').style.display = 'block';
await initCamera();

speak("Welcome to the Trust Your Sight retinal scanner.");
document.getElementById('instructionText').innerHTML = `<strong>Welcome to Trust Your Sight!</strong><br>üì± Hold your phone 6-8 inches from your face<br>üëÅÔ∏è We'll scan both eyes with 9 positions each<br>üîä Listen for audio instructions<br>‚è±Ô∏è Total scan time: About 2 minutes<br><small>Initializing camera...</small>`;

setTimeout(() => {
speak("Initializing camera. Please hold your phone steady.");
setTimeout(() => {
beginScanning();
}, 2000);
}, 2000);
}

function beginScanning() {
isScanning = true;
currentPosition = 0;
currentEye = 'right';
document.getElementById('instructionText').innerHTML = `<strong>Starting RIGHT eye scan</strong><br>üëã Cover your LEFT eye with your hand<br>üì± Keep phone 6-8 inches away<br>üéØ Look directly at the camera<br>‚ö° Keep your head straight and still<br><small>Ready to begin first position...</small>`;

// Say cover instruction once for right eye
speak("Cover your left eye with your hand.");
setTimeout(() => {
scanNextPosition();
}, 4000);
}

async function scanNextPosition() {
if (!isScanning || isPaused) return;

if (currentPosition >= scanPositions.length) {
if (currentEye === 'right') {
currentEye = 'left';
currentPosition = 0;
speak("Great. Now we'll scan your left eye. Please cover your right eye with your hand.");
document.getElementById('instructionText').innerHTML = `<strong>Now scanning LEFT eye</strong><br>üëã Cover your RIGHT eye with your hand<br>üì± Keep phone 6-8 inches away<br>üéØ Look directly at the camera<br><small>Starting left eye positions...</small>`;
scanningTimeout = setTimeout(() => {
if (isScanning) scanNextPosition();
}, 4000);
return;
} else {
completeScan();
return;
}
}

const position = scanPositions[currentPosition];
const eyeTarget = document.getElementById('eyeTarget');
const progressText = `${currentEye.toUpperCase()} Eye: Position ${currentPosition + 1} of ${scanPositions.length}`;

document.getElementById('instructionText').innerHTML = `<strong>${position.text}</strong><br>${position.emoji}<br><small>${progressText}</small>`;

// FIXED: Only speak the position, not the cover instruction
speak(position.text);

const totalPositions = scanPositions.length * 2;
const currentTotal = currentEye === 'right' ? currentPosition : scanPositions.length + currentPosition;
const progressPercent = (currentTotal / totalPositions) * 100;
document.getElementById('progressFill').style.width = `${progressPercent}%`;

eyeTarget.className = 'eye-target positioned';

scanningTimeout = setTimeout(() => {
if (!isScanning || isPaused) return;
eyeTarget.className = 'eye-target capturing';
playBeep();
if (navigator.vibrate) navigator.vibrate(200);
scanningTimeout = setTimeout(() => {
if (!isScanning || isPaused) return;
eyeTarget.className = 'eye-target captured';
speak("Captured");
currentPosition++;
scanningTimeout = setTimeout(() => {
if (isScanning && !isPaused) scanNextPosition();
}, 1200);
}, 1000);
}, 3000);
}

function continueScanning() {
if (isScanning && !isPaused) {
scanNextPosition();
}
}

function completeScan() {
isScanning = false;
document.getElementById('progressFill').style.width = '100%';
if (stream) {
stream.getTracks().forEach(track => track.stop());
}
speak("Scan complete. Analyzing your results.");
document.getElementById('instructionText').innerHTML = `<strong>Scan Complete!</strong><br>üéâ Analyzing your retinal images...<br><small>Processing 18 captured images</small>`;
setTimeout(() => {
speak("Your results are ready for review.");
setTimeout(() => {
showResults();
}, 1000);
}, 3000);
}

function stopScanning() {
isScanning = false;
isPaused = false;
currentPosition = 0;
currentEye = 'right';
clearTimeout(scanningTimeout);
if (stream) {
stream.getTracks().forEach(track => track.stop());
stream = null;
}
}

// Results functions
function showResults() {
document.getElementById('scanningSection').style.display = 'none';
document.getElementById('resultsSection').style.display = 'block';
populateResults();
}

function showDemoResults() {
document.getElementById('welcomeSection').style.display = 'none';
document.getElementById('resultsSection').style.display = 'block';
populateResults();
}

function populateResults() {
const resultsGrid = document.getElementById('resultsGrid');
resultsGrid.innerHTML = '';
demoResults.forEach(result => {
const resultCard = document.createElement('div');
resultCard.className = 'result-card';
resultCard.innerHTML = `<div class="result-header"><div class="result-title">${result.title}</div><div class="confidence-badge confidence-${result.confidence}">${result.confidence} confidence</div></div><div class="result-description">${result.description}</div>`;
resultsGrid.appendChild(resultCard);
});
}

function startNewScan() {
stopScanning();
document.getElementById('resultsSection').style.display = 'none';
startScan();
}

function goHome() {
stopScanning();
document.getElementById('resultsSection').style.display = 'none';
document.getElementById('welcomeSection').style.display = 'block';
}

function shareResults() {
const shareData = { title: 'Trust Your Sight - Eye Health Scan Results', text: 'I just completed an AI-powered eye health scan. Check out the results!', url: window.location.href };
if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
navigator.share(shareData).catch(error => { console.log('Share error:', error); fallbackShare(); });
} else {
fallbackShare();
}
}

function fallbackShare() {
if (navigator.clipboard) {
navigator.clipboard.writeText(`Trust Your Sight Eye Scan Complete! ${window.location.href}`).then(() => { alert('Results link copied to clipboard!'); }).catch(() => { alert('Trust Your Sight Scan Complete!'); });
} else {
alert('Trust Your Sight Scan Complete!');
}
}

function showTestimonials() {
alert('User Stories & Testimonials\n\nHave a success story with Trust Your Sight?\n\nWe\'d love to hear how our app helped with your eye health journey!\n\nContact us: testimonials@trustyoursight.com\n\nShare your experience and help others prioritize their vision health.\n\nNote: Always follow up with professional medical care.');
}

console.log('Trust Your Sight - Complete Fixed Version Ready!');
</script>
</body>
</html>
