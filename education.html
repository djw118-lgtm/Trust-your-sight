<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eye Test</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background: #f5f5f5; }
    .card { max-width: 650px; margin: auto; padding: 30px; border-radius: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .instructions { font-size: 1.2em; margin-bottom: 30px; min-height: 120px; }
    button { padding: 12px 24px; font-size: 1.1em; border: none; border-radius: 12px; background: #0078d7; color: white; cursor: pointer; }
    button:disabled { background: gray; }
    .hidden { display: none; }
    video { width: 100%; max-width: 500px; margin-top: 20px; border-radius: 12px; }
    label { display: block; margin: 10px 0; font-size: 1em; text-align: left; }
  </style>
</head>
<body>

<!-- Consent / Education Checklist -->
<div id="consent" class="card">
  <h2>Before We Begin</h2>
  <p>Please review and check all of the following:</p>

  <label><input type="checkbox" class="chk"> I am over 18 years old</label>
  <label><input type="checkbox" class="chk"> I consent to continue</label>
  <label><input type="checkbox" class="chk"> I will hold my phone 6–8 inches from my eyes</label>
  <label><input type="checkbox" class="chk"> I will keep my head still and only move my eyes</label>
  <label><input type="checkbox" class="chk"> I understand the test goes clockwise (12, 1, 3, 5, 6, 7, 9, 11)</label>
  <label><input type="checkbox" class="chk"> I will follow each instruction and hold steady</label>
  <label><input type="checkbox" class="chk"> I am ready to begin the eye test</label>

  <button id="consentBtn" disabled>Begin Eye Test</button>
</div>

<!-- Eye Test -->
<div id="test" class="card hidden">
  <h2>Eye Test</h2>
  <div class="instructions" id="step">Preparing the test…</div>
  <video id="camera" autoplay playsinline></video>
</div>

<!-- Completion -->
<div id="complete" class="card hidden">
  <h2>Eye Test Complete</h2>
  <p>Thank you. Your eyes have been checked successfully.</p>
</div>

<script>
const synth = window.speechSynthesis;
const camera = document.getElementById("camera");
const checks = document.querySelectorAll(".chk");
const btn = document.getElementById("consentBtn");

// Enable button only when all boxes are checked
checks.forEach(c => c.addEventListener("change", () => {
  btn.disabled = ![...checks].every(chk => chk.checked);
}));

btn.addEventListener("click", () => {
  document.getElementById("consent").classList.add("hidden");
  document.getElementById("test").classList.remove("hidden");
  startCamera();
  speak(setupText, () => { runTest(); });
});

// Setup narration
const setupText = `Hold your phone six to eight inches in front of your eyes. 
Keep your head still and move only your eyes. 
We will guide you clockwise through the test. 
We will start straight ahead, then one o'clock, three o'clock, five o'clock, six o'clock, seven o'clock, nine o'clock, eleven o'clock, and finally twelve o'clock. 
Please hold steady at each point until told to move.`;

// Test steps
const steps = [
  "Look straight ahead. Hold steady.",
  "Look up, twelve o’clock. Hold steady.",
  "Look up-right, one o’clock. Hold steady.",
  "Look right, three o’clock. Hold steady.",
  "Look down-right, five o’clock. Hold steady.",
  "Look down, six o’clock. Hold steady.",
  "Look down-left, seven o’clock. Hold steady.",
  "Look left, nine o’clock. Hold steady.",
  "Look up-left, eleven o’clock. Hold steady."
];

let stepIndex = 0;

function runTest() {
  if (stepIndex < steps.length) {
    const text = steps[stepIndex];
    document.getElementById("step").textContent = text;
    speak(text, () => {
      setTimeout(() => { stepIndex++; runTest(); }, 2500);
    });
  } else {
    finishTest();
  }
}

function speak(text, callback) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.onend = callback;
  synth.speak(utter);
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { camera.srcObject = stream; })
    .catch(err => { console.error("Camera error:", err); });
}

function finishTest() {
  const tracks = camera.srcObject ? camera.srcObject.getTracks() : [];
  tracks.forEach(track => track.stop());
  document.getElementById("test").classList.add("hidden");
  document.getElementById("complete").classList.remove("hidden");
  speak("Eye test complete. Thank you.");
}
</script>
</body>
</html>
