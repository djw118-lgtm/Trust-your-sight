<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trust Your Sight - Scanner Demo</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
    }
    header {
      background: #111;
      color: #fbbf24;
      text-align: center;
      padding: 10px;
      font-weight: 600;
      z-index: 1000;
      position: relative;
    }
    .scanner-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .camera-view {
      flex: 1;
      position: relative;
      background: #000;
    }
    #scannerVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
    }
    .eye-target {
      position: absolute;
      top: 50%; left: 50%;
      width: 120px; height: 120px;
      border: 3px solid #22c55e;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }
    .eye-target.capturing {
      border-color: #ef4444;
      background: rgba(239,68,68,0.2);
    }
    .direction-arrow {
      position: absolute;
      top: 30%; left: 50%;
      transform: translateX(-50%);
      font-size: 48px;
      color: #22c55e;
    }
    .progress-indicator {
      position: absolute;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 10px 20px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: 600;
    }
    .scan-complete {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      display: none;
      width: 90%;
      max-width: 500px;
    }
    .scan-complete.show { display: block; }
    .results-card {
      background: #1a1a1a;
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      text-align: left;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .results-card.show {
      opacity: 1;
      transform: translateY(0);
    }
    .results-card.green { border-left: 6px solid #22c55e; }
    .results-card.yellow { border-left: 6px solid #facc15; }
    .results-card.red { border-left: 6px solid #ef4444; }
    .results-card h3 { margin: 0 0 8px 0; }
    .results-card p { margin: 0; font-size: 14px; color: #ccc; }
    .results-actions {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .results-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-back { background: #22c55e; color: #fff; }
    .btn-new { background: #3b82f6; color: #fff; }
    .btn-share { background: #6b7280; color: #fff; }
    .btn-print { background: #f59e0b; color: #fff; }
    .btn-story { background: #9333ea; color: #fff; }
    .brand-tagline {
      margin-top: 25px;
      margin-bottom: 10px;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
    }
    .brand-tagline .sight { color: #22c55e; }
    .brand-tagline .future { color: #fbbf24; }
    .references {
      margin-top: 15px;
      font-size: 13px;
      color: #aaa;
      text-align: left;
    }
    .references a { color: #3b82f6; }
    .references h4 { margin: 10px 0; color: #fff; }
  </style>
</head>
<body>
  <header>‚ö†Ô∏è Demo Version ‚Äî No real diagnosis or payment</header>
  <div class="scanner-container">
    <div class="camera-view">
      <video id="scannerVideo" autoplay muted playsinline></video>
      <div class="overlay">
        <div class="eye-target" id="eyeTarget"></div>
        <div class="direction-arrow" id="directionArrow">üëÅÔ∏è</div>
      </div>
      <div class="progress-indicator" id="progressText">Starting scan...</div>
    </div>
    <div class="scan-complete" id="scanComplete">
      <h2>‚úÖ Scan Complete!</h2>
      <p id="timestamp"></p>
      <div id="resultsContainer"></div>
      <div class="results-actions">
        <button class="btn-back" onclick="backToStart()">‚¨ÖÔ∏è Back to Start</button>
        <button class="btn-new" onclick="restartScan()">üîÑ New Scan</button>
        <button class="btn-share" onclick="shareResults()">üì§ Share</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print / Save PDF</button>
        <button class="btn-story" onclick="shareStory()">üó£Ô∏è Share Your Story</button>
      </div>
      <div class="brand-tagline">
        üëÅÔ∏è <span class="sight">Trust Your Sight</span> ‚Äî <span class="future">Trust Your Future</span>
      </div>
      <div class="references">
        <h4>References & Further Reading</h4>
        <ul>
          <li><a href="https://research.google/blog/improving-the-effectiveness-of-diabetic-retinopathy-models/" target="_blank">Google Research: Improving the Effectiveness of Diabetic Retinopathy Models</a></li>
          <li><a href="https://research.google/blog/detecting-signs-of-disease-from-external-images-of-the-eye/" target="_blank">Google Health: Detecting Signs of Disease from External Images of the Eye</a></li>
          <li><a href="https://www.nei.nih.gov/learn-about-eye-health/eye-conditions-and-diseases/diabetic-retinopathy" target="_blank">National Eye Institute: Diabetic Retinopathy</a></li>
        </ul>
        <p>‚ö†Ô∏è Demo results are not medical grade. Please consult your doctor for a professional diagnosis. In the near future, medical-grade results will be available here on this app.</p>
      </div>
    </div>
  </div>

  <script>
    let currentEye = 'right';
    let currentPosition = 0;
    const totalPositions = 9;
    let isScanning = false;

    const scanPositions = [
      { instruction: 'Look straight ahead', arrow: 'üëÅÔ∏è' },
      { instruction: 'Look up', arrow: '‚¨ÜÔ∏è' },
      { instruction: 'Look up-right', arrow: '‚ÜóÔ∏è' },
      { instruction: 'Look right', arrow: '‚û°Ô∏è' },
      { instruction: 'Look down-right', arrow: '‚ÜòÔ∏è' },
      { instruction: 'Look down', arrow: '‚¨áÔ∏è' },
      { instruction: 'Look down-left', arrow: '‚ÜôÔ∏è' },
      { instruction: 'Look left', arrow: '‚¨ÖÔ∏è' },
      { instruction: 'Look up-left', arrow: '‚ÜñÔ∏è' }
    ];

    function speak(text) {
      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
      }
    }

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        document.getElementById('scannerVideo').srcObject = stream;
        setTimeout(startScanning, 1500);
      } catch (err) {
        alert("Camera access required.");
      }
    }

    function startScanning() {
      if (isScanning) return;
      isScanning = true;
      currentEye = 'right';
      currentPosition = 0;
      speak("Starting scan. Cover your left eye.");
      setTimeout(() => performPosition(), 2000);
    }

    function performPosition() {
      if (!isScanning) return;
      const pos = scanPositions[currentPosition];
      const eyeText = currentEye === 'right' ? "Right Eye" : "Left Eye";
      document.getElementById('progressText').textContent =
        `${eyeText} - Position ${currentPosition+1} of ${totalPositions}`;
      document.getElementById('directionArrow').textContent = pos.arrow;

      speak(pos.instruction);

      setTimeout(() => {
        speak("Hold steady");
        document.getElementById('eyeTarget').className = 'eye-target';
        setTimeout(() => capturePosition(), 4000);
      }, 2000);
    }

    function capturePosition() {
      if (!isScanning) return;
      const target = document.getElementById('eyeTarget');
      target.className = 'eye-target capturing';
      speak("Captured");

      setTimeout(() => {
        target.className = 'eye-target';
        nextPosition();
      }, 1500);
    }

    function nextPosition() {
      currentPosition++;
      if (currentPosition >= totalPositions) {
        if (currentEye === 'right') {
          currentEye = 'left';
          currentPosition = 0;
          speak("Switch eyes. Cover your right eye.");
          setTimeout(() => performPosition(), 3000);
        } else {
          completeScan();
        }
      } else {
        performPosition();
      }
    }

    function completeScan() {
      isScanning = false;
      speak("Scan complete. Analyzing results.");
      setTimeout(showResults, 2500);
    }

    function showResults() {
      const ts = new Date();
      document.getElementById('timestamp').textContent =
        "Generated: " + ts.toLocaleString();

      const container = document.getElementById('resultsContainer');
      container.innerHTML = "";
      const resultPool = [
        {title:"Normal retina detected", text:"Healthy structure observed.", color:"green"},
        {title:"General eye health", text:"No significant findings.", color:"green"},
        {title:"Possible diabetic changes", text:"Irregular patterns detected.", color:"yellow"},
        {title:"Retinal blood vessel irregularities", text:"Some stress noted.", color:"yellow"},
        {title:"Cardiovascular stress", text:"Signs of vascular strain.", color:"red"},
        {title:"Hypertension indicators", text:"Possible high blood pressure.", color:"red"},
        {title:"Cholesterol deposits", text:"Minor deposits visible.", color:"yellow"},
        {title:"Optic nerve stress", text:"Some pressure observed.", color:"red"},
        {title:"Neurological health", text:"No risk factors detected.", color:"green"},
        {title:"Healthy blood vessel flow", text:"Normal circulation patterns.", color:"green"}
      ];

      let shuffled = resultPool.sort(() => 0.5 - Math.random());
      let picked = shuffled.slice(0,4);

      if (!picked.some(r=>r.color==="green")) picked[0] = resultPool.find(r=>r.color==="green");
      if (!picked.some(r=>r.color!=="green")) picked[1] = resultPool.find(r=>r.color!=="green");

      picked.forEach((r, i)=>{
        const div = document.createElement('div');
        div.className = `results-card ${r.color}`;
        div.innerHTML = `<h3>${r.title}</h3><p>${r.text}</p>`;
        container.appendChild(div);
        setTimeout(()=>div.classList.add("show"), i*500);
      });

      document.getElementById('scanComplete').classList.add('show');
    }

    function backToStart() { window.location.href = "index.html"; }
    function restartScan() { location.reload(); }
    function shareResults() {
      if (navigator.share) {
        navigator.share({
          title: "Trust Your Sight Demo Results",
          text: "Here are my demo retinal scan results.",
          url: window.location.href
        });
      } else {
        alert("Sharing not supported on this device.");
      }
    }
    function shareStory() {
      alert("In the live version, this button will let you share your testimonial.");
    }

    document.addEventListener('DOMContentLoaded', initCamera);
  </script>
</body>
</html>
